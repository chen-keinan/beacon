{
  "benchmark_type": "k8s",
  "categories": [
    {
      "name": "Control Plane Components",
      "sub_category": {
        "name": "API Server",
        "audit_tests": [
          {
            "name": "Ensure that the --anonymous-auth argument is set to false (Manual)",
            "description": "Disable anonymous requests to the API server.",
            "profile_applicability": "Level 1 - Master Node",
            "audit": "ps -ef | grep kube-apiserver |grep 'anonymous-auth' | grep -o 'anonymous-auth=[^\"]\\S*' | awk -F \"=\" '{print $2}' |awk 'FNR <= 1'",
            "remediation": "Edit the API server pod specification file /etc/kubernetes/manifests/kube- apiserver.yaml on the master node and set the below parameter.\n--anonymous-auth=false",
            "check_type": "process_param",
            "impact": "Anonymous requests will be rejected.",
            "eval_expr": "'$1' == 'false'",
            "default_value": "By default, anonymous access is enabled.",
            "references": [
              "https://kubernetes.io/docs/admin/kube-apiserver/",
              "https://kubernetes.io/docs/admin/authentication/#anonymous-requests"
            ]
          },
          {
            "name": "Ensure that the --basic-auth-file argument is not set (Automated)",
            "description": "Do not use basic authentication.",
            "profile_applicability": "Level 1 - Master Node",
            "audit": "ps -ef | grep kube-apiserver |grep 'basic-auth-file' | grep -o 'basic-auth-file=[^\"]\\S*' | awk -F \"=\" '{print $2}' |awk 'FNR <= 1'",
            "remediation": "Follow the documentation and configure alternate mechanisms for authentication. Then, edit the API server pod specification file /etc/kubernetes/manifests/kube- apiserver.yaml on the master node and remove the --basic-auth-file=<filename> parameter.",
            "check_type": "process_param",
            "impact": "You will have to configure and use alternate authentication mechanisms such as tokens and certificates. Username and password for basic authentication could no longer be used.",
            "eval_expr": "'$1' == ''",
            "default_value": "By default, basic authentication is not set.",
            "references": [
              "https://kubernetes.io/docs/admin/kube-apiserver/",
              "https://kubernetes.io/docs/admin/authentication/#static-password-file"
            ]
          },
          {
            "name": "Ensure that the --token-auth-file parameter is not set (Automated)",
            "description": "Do not use token based authentication.",
            "profile_applicability": "Level 1 - Master Node",
            "audit": "ps -ef | grep kube-apiserver |grep 'token-auth-file' | grep -o 'token-auth-file=[^\"]\\S*' | awk -F \"=\" '{print $2}' |awk 'FNR <= 1'",
            "remediation": "Follow the documentation and configure alternate mechanisms for authentication. Then, edit the API server pod specification file /etc/kubernetes/manifests/kube- apiserver.yaml on the master node and remove the --token-auth-file=<filename> parameter.",
            "check_type": "process_param",
            "impact": "You will have to configure and use alternate authentication mechanisms such as certificates. Static token based authentication could not be used.",
            "eval_expr": "'$1' == ''",
            "default_value": "By default, --token-auth-file argument is not set.",
            "references": [
              "https://kubernetes.io/docs/admin/authentication/#static-token-file",
              " https://kubernetes.io/docs/admin/kube-apiserver/"
            ]
          },
          {
            "name": "Ensure that the --kubelet-https argument is set to true (Automated)",
            "description": "Use https for kubelet connections.",
            "profile_applicability": "Level 1 - Master Node",
            "audit": "ps -ef | grep kube-apiserver |grep 'anonymous-auth' | grep -o 'anonymous-auth=[^\"]\\S*' | awk -F \"=\" '{print $2}' |awk 'FNR <= 1'",
            "remediation": "Follow the documentation and configure alternate mechanisms for authentication. Then, edit the API server pod specification file /etc/kubernetes/manifests/kube- apiserver.yaml on the master node and remove the --token-auth-file=<filename> parameter.",
            "check_type": "process_param",
            "impact": "You require TLS to be configured on apiserver as well as kubelets.",
            "eval_expr": "'$1' == '' || '$1' == 'true'",
            "default_value": "By default, kubelet connections are over https.",
            "references": [
              "https://kubernetes.io/docs/admin/kube-apiserver/",
              "https://kubernetes.io/docs/admin/kubelet-authentication-authorization/"
            ]
          },
          {
            "name": "Ensure that the --kubelet-client-certificate and --kubelet-client-key arguments are set as appropriate (Automated)",
            "description": "Enable certificate based kubelet authentication.",
            "profile_applicability": "Level 1 - Master Node",
            "audit": "ps -ef | grep kube-apiserver |grep 'kubelet-client-certificate' | grep -o 'kubelet-client-certificate=[^\"]\\S*' | awk -F \"=\" '{print $2}' |awk 'FNR <= 1'",
            "remediation": "Follow the Kubernetes documentation and set up the TLS connection between the apiserver and kubelets. Then, edit API server pod specification file /etc/kubernetes/manifests/kube-apiserver.yaml on the master node and set the kubelet client certificate and key parameters as below. --kubelet-client-certificate=<path/to/client-certificate-file> --kubelet-client-key=<path/to/client-key-file>",
            "check_type": "process_param",
            "impact": "You require TLS to be configured on apiserver as well as kubelets.",
            "eval_expr": "'$1' == '/etc/kubernetes/pki/apiserver-kubelet-client.crt'",
            "default_value": "By default, certificate-based kubelet authentication is not set.",
            "references": [
              "https://kubernetes.io/docs/admin/kube-apiserver/",
              "https://kubernetes.io/docs/admin/kubelet-authentication-authorization/",
              "https://kubernetes.io/docs/concepts/cluster-administration/master-node-communication/#apiserver---kubelet"
            ]
          },
          {
            "name": "Ensure that the --kubelet-client-certificate and --kubelet-client-key arguments are set as appropriate (Automated)",
            "description": "Enable certificate based kubelet authentication.",
            "profile_applicability": "Level 1 - Master Node",
            "audit": "ps -ef | grep kube-apiserver |grep 'kubelet-client-key' | grep -o 'kubelet-client-key=[^\"]\\S*' | awk -F \"=\" '{print $2}' |awk 'FNR <= 1'",
            "remediation": "Follow the Kubernetes documentation and set up the TLS connection between the apiserver and kubelets. Then, edit API server pod specification file /etc/kubernetes/manifests/kube-apiserver.yaml on the master node and set the kubelet client certificate and key parameters as below. --kubelet-client-certificate=<path/to/client-certificate-file> --kubelet-client-key=<path/to/client-key-file>",
            "check_type": "process_param",
            "impact": "You require TLS to be configured on apiserver as well as kubelets.",
            "eval_expr": "'$1' == '/etc/kubernetes/pki/apiserver-kubelet-client.key'",
            "default_value": "By default, certificate-based kubelet authentication is not set.",
            "references": [
              "https://kubernetes.io/docs/admin/kube-apiserver/",
              "https://kubernetes.io/docs/admin/kubelet-authentication-authorization/",
              "https://kubernetes.io/docs/concepts/cluster-administration/master-node-communication/#apiserver---kubelet"
            ]
          },
          {
            "name": "Ensure that the --kubelet-certificate-authority argument is set as appropriate (Automated)",
            "description": "Verify kubelet's certificate before establishing connection.",
            "profile_applicability": "Level 1 - Master Node",
            "audit": "ps -ef | grep kube-apiserver |grep 'kubelet-certificate-authority' | grep -o 'kubelet-certificate-authority=[^\"]\\S*' | awk -F \"=\" '{print $2}' |awk 'FNR <= 1'",
            "remediation": "Follow the Kubernetes documentation and setup the TLS connection between the apiserver and kubelets. Then, edit the API server pod specification file /etc/kubernetes/manifests/kube-apiserver.yaml on the master node and set the -- kubelet-certificate-authority parameter to the path to the cert file for the certificate authority. --kubelet-certificate-authority=<ca-string>",
            "check_type": "process_param",
            "impact": "You require TLS to be configured on apiserver as well as kubelets.",
            "eval_expr": "'$1' == '/etc/kubernetes/pki/ca.crt'",
            "default_value": "By default, --kubelet-certificate-authority argument is not set.",
            "references": [
              "https://kubernetes.io/docs/admin/kube-apiserver/",
              "https://kubernetes.io/docs/admin/kubelet-authentication-authorization/",
              "https://kubernetes.io/docs/concepts/cluster-administration/master-node-communication/#apiserver---kubelet"
            ]
          },
          {
            "name": "Ensure that the --authorization-mode argument is not set to AlwaysAllow (Automated)",
            "description": "Do not always authorize all requests.",
            "profile_applicability": "Level 1 - Master Node",
            "audit": "ps -ef | grep kube-apiserver |grep 'authorization-mode' | grep -o 'authorization-mode=[^\"]\\S*' | awk -F \"=\" '{print $2}' |awk 'FNR <= 1'",
            "remediation": "Edit the API server pod specification file /etc/kubernetes/manifests/kube- apiserver.yaml on the master node and set the --authorization-mode parameter to values other than AlwaysAllow. One such example could be as below.\n--authorization-mode=RBAC",
            "check_type": "process_param",
            "impact": "Only authorized requests will be served.",
            "eval_expr": "'$1' != '' && '$1' != 'AlwaysAllow'",
            "default_value": "By default, AlwaysAllow is not enabled.",
            "references": [
              "https://kubernetes.io/docs/admin/kube-apiserver/ ",
              "https://kubernetes.io/docs/admin/authorization/"
            ]
          },
          {
            "name": "Ensure that the --authorization-mode argument includes Node (Automated)",
            "description": "Restrict kubelet nodes to reading only objects associated with them.",
            "profile_applicability": "Level 1 - Master Node",
            "audit": "ps -ef | grep kube-apiserver |grep 'authorization-mode' | grep -o 'authorization-mode=[^\"]\\S*' | awk -F \"=\" '{print $2}' |awk 'FNR <= 1'",
            "remediation": "Edit the API server pod specification file /etc/kubernetes/manifests/kube- apiserver.yaml on the master node and set the --authorization-mode parameter to a value that includes Node. --authorization-mode=Node,RBAC",
            "check_type": "process_param",
            "impact": "None",
            "eval_expr": "'$1' == 'Node,RBAC'",
            "default_value": "By default, Node authorization is not enabled.",
            "references": [
              "https://kubernetes.io/docs/admin/kube-apiserver/",
              "https://kubernetes.io/docs/admin/authorization/node/",
              "https://github.com/kubernetes/kubernetes/pull/46076"
            ]
          },
          {
            "name": "Ensure that the --authorization-mode argument includes RBAC (Automated)",
            "description": "Restrict kubelet nodes to reading only objects associated with them.",
            "profile_applicability": "Level 1 - Master Node",
            "audit": "ps -ef | grep kube-apiserver |grep 'authorization-mode' | grep -o 'authorization-mode=[^\"]\\S*' | awk -F \"=\" '{print $2}' |awk 'FNR <= 1'",
            "remediation": "Edit the API server pod specification file /etc/kubernetes/manifests/kube- apiserver.yaml on the master node and set the --authorization-mode parameter to a value that includes Node. --authorization-mode=Node,RBAC",
            "check_type": "process_param",
            "impact": "None",
            "eval_expr": "'$1' == 'Node,RBAC'",
            "default_value": "By default, Node authorization is not enabled.",
            "references": [
              "https://kubernetes.io/docs/admin/kube-apiserver/",
              "https://kubernetes.io/docs/admin/authorization/node/",
              "https://github.com/kubernetes/kubernetes/pull/46076"
            ]
          }
        ]
      }
    }
  ]
}